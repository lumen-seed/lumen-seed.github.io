name: Build Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug List repository files
        run: |
          echo "Listing root files:"
          ls -l
          echo "Listing boot files:"
          ls -l boot || echo "No boot directory found"

      - name: Build OS.md
        run: |
          set -e

          # Start fresh
          : > OS.md

          # 1. Append README.me if it exists
          if [ -f README.me ]; then
            echo "Appending README.me..."
            cat README.me >> OS.md
            echo -e "\n\n" >> OS.md
          else
            echo "README.me not found."
          fi

          # 2. Append boot/<number>-*.md in numeric order
          boot_files=(boot/[0-9]*-*.md)
          if [ -e "${boot_files[0]}" ]; then
            echo "Appending boot files..."
            # Sort files numerically by prefix
            for file in $(ls boot/[0-9]*-*.md | sort -V); do
              cat "$file" >> OS.md
              echo -e "\n\n" >> OS.md
            done
          else
            echo "No boot files found."
          fi

          # 3. Ensure OS.md is not empty
          if [ ! -s OS.md ]; then
            echo "OS.md is empty. Adding placeholder content."
            echo "# OS.md Placeholder" >> OS.md
          fi

          # Show first few lines for confirmation
          echo "OS.md built successfully. Preview:"
          head -n 10 OS.md

      - name: Upload OS.md artifact
        uses: actions/upload-artifact@v4
        with:
          name: OS.md
          path: OS.md
