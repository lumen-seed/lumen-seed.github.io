name: Build Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug List repository files
        run: |
          echo "Listing root files:"
          ls -l
          echo "Listing boot files:"
          ls -l boot || echo "No boot directory found"

      - name: Build OS.md
        run: |
          set -e

          # Start fresh
          : > OS.md

          # 1 The Lumen Boot Sequence
          echo "# The Lumen Modules (Boot Sequence)" >> OS.md
          echo "## All lumen modules should comply with Lumen and UCS" >> OS.md

          echo -e "\n\n" >> OS.md

          # 2. Append boot/<number>-*.md in numeric order
          boot_files=(boot/[0-9]*-*.md)
          if [ -e "${boot_files[0]}" ]; then
            echo "Appending boot files..."
            # Sort files numerically by prefix
            for file in $(ls boot/[0-9]*-*.md | sort -V); do
              echo "[$file] " >> OS.md
              cat "$file" >> OS.md
              echo -e "\n\n" >> OS.md
            done
          else
            echo "No boot files found."
          fi

          # 2. Append db/*.md in numeric order (Pattern: lumen-db-YYYYMMDD-topic.md)
          # We check for the files using the specific prefix
          files=(db/lumen-db-[0-9]*).md)

          if [ -e "${files[0]}" ]; then
            echo "Appending db files..."
            
            # sort -V (version sort) correctly handles the YYYYMMDD numeric sequence
            for file in $(ls db/lumen-db-[0-9]*.md | sort -V); do
              echo "[$file] " >> OS.md
              cat "$file" >> OS.md
              echo -e "\n\n" >> OS.md
            done
          else
            echo "No db files found matching the pattern."
          fi

          # 3. Ensure OS.md is not empty
          if [ ! -s OS.md ]; then
            echo "OS.md is empty. Adding placeholder content."
            echo "# OS.md Placeholder" >> OS.md
          fi

          # Show first few lines for confirmation
          echo "OS.md built successfully. Preview:"
          head -n 10 OS.md

      - name: Upload OS.md artifact
        uses: actions/upload-artifact@v4
        with:
          name: OS.md
          path: OS.md

      - name: Create GitHub Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: v1.0.${{ github.run_number }}
          name: "OS.md Release v1.0.${{ github.run_number }}"
          body: |
            Automated release generated by GitHub Actions.
            Includes OS.md built from latest main branch.
          artifacts: OS.md
          draft: false
          prerelease: false
          makeLatest: true
